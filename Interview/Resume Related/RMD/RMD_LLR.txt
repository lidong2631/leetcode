USE [DATA_MART_US]
GO
/****** Object:  StoredProcedure [dbo].[RMD_LLR]    Script Date: 09/19/2014 11:04:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[RMD_LLR] AS
BEGIN

SELECT CONTACT_ID,CATEGORY,
--DESC1,
APPLICATION_ID,
CUSTOMER_NO,
SHORT_NAME,
CUST.SECTOR,
CUSTOMER_STATUS,
CONTINGENT_RISK,
DEAL_LOCAL_BAL * (-1) AS DEAL_LOCAL_BAL,
FMD.COMPANY,
LLR_PRODUCT,
LLR_WEIGHT,
CASE LLR_RATING_YN  
     WHEN 'Y' THEN 
			CASE CATEGORY
			WHEN 21068
			THEN 
				CASE CUST.SECTOR
				WHEN 3110
				THEN CONTINGENT_RISK
				ELSE CUSTOMER_STATUS
				END
			ELSE CONTINGENT_RISK
			END
	 ELSE  CUSTOMER_STATUS
END AS RISK_RATING,
FMD.ASOFDATE
FROM T_FMDDATA FMD
LEFT JOIN dbo.FBNK_CUSTOMER CUST
ON FMD.CUSTOMER_NO = CUST.CUSTOMER_CODE
LEFT JOIN RE_RMD_LLR
ON CATEGORY = LLR_CATEGORY AND DESC1 = LLR_DESC1
WHERE  CATEGORY IN 
(SELECT LLR_CATEGORY FROM [RE_RMD_LLR])
AND DESC1 IN (SELECT LLR_DESC1 FROM [RE_RMD_LLR] WHERE LLR_CATEGORY = CATEGORY )
AND CONTACT_ID IS NOT NULL
AND CONTACT_ID <> 'ZZY'
--3/22/2011  remove 21068
--AND CATEGORY NOT IN (21068,21079)
--AND CATEGORY NOT IN (21079)
AND (CUST.SECTOR < '3000' OR CUST.SECTOR > '3015')
--ORDER BY LLR_PRODUCT,LLR_CATEGORY,LLR_DESC1,CONTACT_ID


UNION

SELECT CREDIT_LINE_NO,
      '' AS CATEGORY,
      '' AS APPLICATION_ID,
      SUBSTRING(CREDIT_LINE_NO,1,7) AS CUSTOMER_NO,SHORT_NAME,
      CUST.SECTOR,CUSTOMER_STATUS,
      CONTINGENT_RISK,
      CONVERT(DECIMAL(19,2), AVAIL_AMT) AS DEAL_LOCAL_BAL,
       (CASE ALLOWED_COMP
            WHEN 'US0010001' THEN 'BNK'
            WHEN 'US0010002' THEN 'NIB'
            WHEN 'US0010006' THEN 'LAB'
            WHEN 'US0010007' THEN 'LIB'
            WHEN 'US0010008' THEN 'CTB'
            ELSE 'BNK'
       END) AS COMPANY, 
       LLR_PRODUCT,
       LLR_WEIGHT,
       CUSTOMER_STATUS AS RISK_RATING,
       LIMIT.ASOFDATE 
FROM dbo.FBNK_LIMIT LIMIT
LEFT JOIN dbo.FBNK_CUSTOMER CUST
ON SUBSTRING(LIMIT.CREDIT_LINE_NO,1,7) = CUST.CUSTOMER_CODE
LEFT JOIN RE_RMD_LLR
ON LLR_PRODUCT = '1-LIMIT'
WHERE SUBSTRING(CREDIT_LINE_NO,9,8) IN ('0010000.' ,'0020000.' )
AND LEN(CREDIT_LINE_NO) = 18
AND COMMITTED_YN = 'Y'
AND AVAIL_AMT <> '0'
AND (CUST.SECTOR < '3000' OR CUST.SECTOR > '3015')

UNION

SELECT CONTACT_ID,
      CATEGORY,
      APPLICATION_ID,
      CUSTOMER_NO,
      SHORT_NAME,
      CUST.SECTOR,
      CUSTOMER_STATUS,
      CONTINGENT_RISK,
      DEAL_LOCAL_BAL,
      FMD.COMPANY,
      LLR_PRODUCT,LLR_WEIGHT,
      CASE LLR_RATING_YN  
           WHEN 'Y' THEN CONTINGENT_RISK
      	 ELSE  CUSTOMER_STATUS
      END AS RISK_RATING,
      FMD.ASOFDATE
FROM T_FMDDATA FMD
LEFT JOIN dbo.FBNK_CUSTOMER CUST
ON FMD.CUSTOMER_NO = CUST.CUSTOMER_CODE
LEFT JOIN RE_RMD_LLR
ON CATEGORY = LLR_CATEGORY
AND DESC1 = LLR_DESC1
WHERE  CATEGORY IN 
(SELECT LLR_CATEGORY FROM [RE_RMD_LLR])
AND DESC1 IN (SELECT LLR_DESC1 FROM [RE_RMD_LLR] WHERE LLR_CATEGORY = CATEGORY )
AND CONTACT_ID IS NOT NULL
AND CONTACT_ID <> 'ZZY'
AND  CONTACT_ID IN
(SELECT LC_NUMBER FROM dbo.MULTI_LC
WHERE SUBSTRING(LIMIT_REFERENCE,1,4) = '500.')
AND DESC1 IN ('9116','9168','9115')
AND DEAL_LOCAL_BAL <> '0'
--ORDER BY LLR_PRODUCT,LLR_CATEGORY,LLR_DESC1,CONTACT_ID

END
